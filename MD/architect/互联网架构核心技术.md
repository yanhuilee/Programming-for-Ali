#### 1、水平分层架构
水平方向物理分成多个独立进程：
- DNS域名解析，静态资源获取
- 网关层
- 异步消息队列层
- 业务逻辑层
- 数据访问层
- 数据存储层：MySQL/TiDB

每层逻辑解耦

##### 网关层功能
- 请求鉴权：发布商品，登录鉴权
- 数据完整性检查：数据包定长Header + 变长Body
- 协议转换：json -> map/string/object
- 路由转发：根据CMD转发到不同业务逻辑层
- 服务治理：限流，降级，熔断等

##### 数据访问层功能
- CRUD：批量
- ORM：MyBatis3
- Sharding-JDBC
- 屏蔽底层存储差异性：MySQL/Redis

#### 2、常见设计手段
##### 高可用
硬件：网络划分

评估方式：4个9，一段时间停机时间影响请求量/总请求量

高可用设计手段：
- 无状态化：服务冗余
- 负载均衡：幂等设计
- 异步化设计：超时机制
- 数据复制/缓存/Sharding：服务限流降级熔断
- 架构拆分，服务治理
- 服务实时监控：请求平均耗时，请求异常条数

##### 高可用
- 网关层：热开关切换

如何无逢停止线上服务

##### 服务幂等
> 用户对于同一操作发起的一次请求或者多次请求的结果是一致的

请求幂等


##### 分布式锁
##### 分布式事务
##### 服务降级
##### 服务限流/熔断
##### 灰度发布
##### 全链路压测

---

#### 动静分离
##### 1、静态页面和文件：
页面静态化：CDN, Nginx, squid/varnish

适合数据量不大，静态页面数量不多的业务

##### 2、动态页面
- 搜索结果页，商品列表页，订单中心页
- 分层架构，服务化架构，数据库缓存

##### 前后台分离
前台与后台的数据与访问分离

前台展现数据，后台抓取数据分离

#### 高并发方案
指标：QPS, 响应时间, 带宽, PV, UV(去重后独立访问用户数)

应对高并发常见优化方案
- 服务拆分：分而治之，将项目水平扩展
- 服务化：复杂调用的服务注册与发现问题
- 数据库缓存：减少磁盘IO，提高并发量
- 消息队列
- CDN加速
- 服务器集群化，以及负载均衡：七层负载均衡（Nginx）

> CDN：Content Delivery Network，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离等综合信息将用户的请求重新导向离用户最近的服务节点上

使用CDN的优势：CDN的本质是内存缓存，就近访问，提高了企业站点（尤其含有大量图片和静态页面的站点）的访问速度，跨运营商的网络加速，保证不同网络的用户都得良好的访问质量。同时，减少远程访问的带宽，分担网络流量，减轻原站点WEB服务器负载。

Nginx: 自动剔除工作异常服务器，上传文件使用异步模式，支持多种分配策略

- 内置策略：IP Hash、加权轮询
- 扩展策略：fair策略，通用hash，一致性hash

> 加权轮询：首先将请求都分给高权重的机器，直到该机器的权值低于其他机器

#### 高可用方案
冗余、限流、降级

##### 限流方式：
1. 限制瞬时并发数 ： 比如在入口层（nginx添加nginx_http_limit_conn_module）来限制同一个ip来源的连接数，防止恶意攻击访问的情况
2. 限制总并发数：通过配置数据库连接池、线程池大小来约束总并发数
3. 限制时间窗口内的平均速率：在接口层面，通过限制访问速率来控制接口的并发请求
4. 其他方式：限制远程接口的调用速率、限制MQ的消费速率

接口限流算法：漏桶算法&令牌桶算法

