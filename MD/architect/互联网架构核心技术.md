#### 1、水平分层架构
水平方向物理分成多个独立进程：
- DNS域名解析，静态资源获取
- 网关层
- 异步消息队列层
- 业务逻辑层
- 数据访问层
- 数据存储层：MySQL/TiDB

每层逻辑解耦

##### 网关层功能
- 请求鉴权：发布商品，登录鉴权
- 数据完整性检查：数据包定长Header + 变长Body
- 协议转换：json -> map/string/object
- 路由转发：根据CMD转发到不同业务逻辑层
- 服务治理：限流，降级，熔断等

##### 数据访问层功能
- CRUD：批量
- ORM：MyBatis3
- Sharding-JDBC
- 屏蔽底层存储差异性：MySQL/Redis


#### 2、常见设计手段
##### 高可用
硬件：网络划分

评估方式：4个9，一段时间停机时间影响请求量/总请求量

高可用设计手段：
- 无状态化：服务冗余
- 负载均衡：幂等设计
- 异步化设计：超时机制
- 数据复制/缓存/Sharding：服务限流降级熔断
- 架构拆分，服务治理
- 服务实时监控：请求平均耗时，请求异常条数

- 网关层：热开关切换

如何无逢停止线上服务

##### 高并发设计手段
##### 服务无状态化设计：弹性扩容缩容
定义：
- 冗余部署的多个模块（进程）完全对等
- 请求提交到冗余部署的任一模块，处理结果完成一样

- 模块不存储业务的上下文信息
- 仅根据每次请求携带数据进行相应的业务逻辑处理

定义：
- 用户session数据
	- 登录方式：用户名+密码；手机号+验证码
	- 登录成功：生成用户凭证（session）；AES（UID+Timestamp+校验码）
- 用户session数据存放在哪里？
- 用户session数据如何存放？

用户名密码加密放在本地

##### 服务幂等
> 请求层面：用户对于同一操作发起的一次请求或者多次请求的结果是一致的
> 业务层面：同一用户不重复下单，商品不超卖，MQ消费端去重

幂等范围：
- 读/写请求层面：请求对数据造成改变 - 写请求
- 架构层面：数据访问层

```
# 年龄加1
set age = age + 1 where age = 18  #增加where条件
set age = 19  #相对修改转换成绝对修改
```

业务层面幂等：
- 冗余部署多个进程：
	- 存在并发消费的可能性
	- 并发转变成串行消费
- 本质：分布式锁问题

##### 分布式事务
##### 服务降级
##### 服务限流/熔断
##### 灰度发布
##### 全链路压测

---

#### 动静分离
##### 1、静态页面和文件：
页面静态化：CDN, Nginx, squid/varnish

适合数据量不大，静态页面数量不多的业务

##### 2、动态页面
- 搜索结果页，商品列表页，订单中心页
- 分层架构，服务化架构，数据库缓存

##### 前后台分离
前台与后台的数据与访问分离

前台展现数据，后台抓取数据分离


#### 高可用方案
冗余、限流、降级

##### 限流方式：
1. 限制瞬时并发数 ： 比如在入口层（nginx添加nginx_http_limit_conn_module）来限制同一个ip来源的连接数，防止恶意攻击访问的情况
2. 限制总并发数：通过配置数据库连接池、线程池大小来约束总并发数
3. 限制时间窗口内的平均速率：在接口层面，通过限制访问速率来控制接口的并发请求
4. 其他方式：限制远程接口的调用速率、限制MQ的消费速率

接口限流算法：漏桶算法&令牌桶算法

