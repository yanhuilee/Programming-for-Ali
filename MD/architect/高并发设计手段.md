#### 高并发相关常见指标：
- QPS：每秒响应请求数
- 响应时间
- 吞吐量：单位时间内处理的请求数量
- 并发用户数：PV, UV(去重后独立访问用户数)

#### 应对高并发常见优化方案
1. 垂直扩展：提升单机处理能力（硬件，使用cache减少IO次数，使用异步增加单服务吞吐量，用无锁数据结构减少响应时间）
2. 水平扩展：增加服务器数量，线性扩充系统性能

- 服务拆分：分而治之，将项目水平扩展
- 服务化：复杂调用的服务注册与发现问题
- 数据库缓存：减少磁盘IO，提高并发量
- 消息队列
- CDN加速
- 服务器集群化，以及负载均衡：七层负载均衡（Nginx）

> CDN：Content Delivery Network，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离等综合信息将用户的请求重新导向离用户最近的服务节点上

使用CDN的优势：CDN的本质是内存缓存，就近访问，提高了企业站点（尤其含有大量图片和静态页面的站点）的访问速度，跨运营商的网络加速，保证不同网络的用户都得良好的访问质量。同时，减少远程访问的带宽，分担网络流量，减轻原站点WEB服务器负载。

Nginx: 自动剔除工作异常服务器，上传文件使用异步模式，支持多种分配策略

- 内置策略：IP Hash、加权轮询
- 扩展策略：fair策略，通用hash，一致性hash

> 加权轮询：首先将请求都分给高权重的机器，直到该机器的权值低于其他机器

### 案例一、电商秒杀系统
#### 特点
- 大量并发，其一时刻99%的用户涌入
- 有效请求数低，可以认为有效请求数和库存一致，可以99%的流量都是无效的
- 库存数据一致性要求严格，不能超卖

#### 设计思路
- 数据分层次检验，上层尽量把无效请求过滤掉
- 上层可以是不精确的过滤
- 层层限流，最后一层做数据一致性检验，扣减库存

#### 实际设计
- 静态文件存放CDN，缓存到用户端/APP/浏览器
- 非实时动态数据（商品标题/描述/图片url列表/店铺信息/秒杀活动信息等），缓存在用户访问链路中最近的位置；粗过滤一部分流量，比如用户是否有秒杀资格，秒杀是否已结束，这些数据实时性要求不高
- 实时数据如用户营销数据（红包/折扣）、商品库存等再过滤一批用户
- 经过多层过滤最终落到数据库的流量已经很少，使用事务保证扣减库存准确性


### 案例二、Feed系统
#### 特点
- 读写比例，100：1甚至更高
- 冷热数据明显：80%是当天数据，20%是活跃用户
- 热点效应明显：热点事件，重大节日
- 高访问量：没事就刷

#### 分级缓存
- 读多写少，冷热数据明显，热点数据缓存到调用链路更靠近用户的地方
- L1缓存容量小负责抗最热点的数据，L2缓存考虑目标容量，缓存更大范围的数据，比如一般用户的timeline，高热点数据单独缓存，比如设置白名单，大V的用户数据单独缓存
- feed（关注的feed/topic的feed/一些运营的feed）前几页的访问比例，像前三页占比97%，针对这种业务特性，把前面几页数据作为热点数据提到L1 cache

#### 存储造型
数据类型 | 特点 | 存储解决方案 | 选型
---|---|---|---
微博内容 | 类型简单，少量访问 | 关系型数据库/K-V存储 | MySQL/TiDB/Pika
微博列表 | 结构化列表数据，多维度查询 | 关系型数据库 | MySQL/TiDB
关系 | 类型简单，高速访问 |  持久化K-V存储 | Redis/Pika 
长微博（图片/短视频） | 对象数据（小文件等） | 对象存储 | Ceph
计数（关注数，粉丝数） | 结构简单，数据及访问量大 | 内存K-V存储 | Redis

FastDFS
数据隔离
朋友圈：推拉结合，排序