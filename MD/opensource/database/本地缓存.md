### 本地缓存
常用的本地缓存实现：
- ConcurrentHashMap
- LinkedHashMap: 可以保持插入或者访问顺序的 HashMap，若配置好是可以当作 LRU cache
- Guava Cache：是一个实现比较完全的本地缓存，包括缓存失效、 LRU 都做了支持。 

load() 是第一次加载对应的 key 的缓存时调用的方法，重载此方法可以实现单一线程回源，而 reload() 的重载，则可以在后台定时刷新数据的过程中依然使用旧数据响应请求，不会造成卡顿，这里默认的实现是 load() 的代理，是同步的，建议重新用异步方式实现。 此外，并行度指的是允许并行修改的线程数，此值建议根据当前机器的 CPU核数来设置。

```java
final int MAX_ENTRIES = 1000; // 最大元素数目
LoadingCache<String, String> cache = CacheBuilder.newBuilder()
	.maximumSize(MAX_ENTRIES)
	.concurrencyLevel(Runtime.getRuntime().availableProcessors()) // 并行度
	.expireAfterWrite(2, TimeUnit.SECONDS) // 写入 2 秒后失效
	.build(new CacheLoader<String, String>() {
		@Override
		public String load(String key) throws Exception {
			return ．．．； ／／异步加载数据到缓存
		}

		@Override
		public ListenableFuture<String> reload(String key, String oldValue) throws Exception {
			return ... 
		}
	});

// Using the cache
String value = cache.getUnchecked("testKey")
```

上述例子中使用了基于 maximumSize 和基于时间 expireA丘erWr巾的缓存剔除，除此之外，还可以通过：

- 1)基于权重的缓存剔除
```java
CacheBuilder.newBuilder().maximumWeight(10000)
	.weigher(new Weigher<String, Object>() {
		@Override
		public int weigh(String key, Object value) {
			return key.length();
		}
	}) 
.build()
```

这样当 cache 中 put 一个 key 时，都会计算它的 weight 值井累加，当达到 maximum Weight 阀值时，会触发剔除操作。

- 2)制定 key 和I value 使用的引用类型来做缓存剔除
```java
CacheBuilder.newBuilder().weakKeys();
CacheBuilder.newBuilder().weakValues();
CacheBuilder.newBuilder().softValues();
```

还需要指明的一点是， Guava Cache 中的缓存失效并非立即生效，通常是延迟的，在各种写人数据时都去检查并 cleanUp。

此外， Guava Cache还提供了 asMap视图，可以获取保存数据使用的 ConcurrentMap形式。使用时需要注意读/写操作会重置相关缓存项的访问时间，包括 `asMap().get() 和 Cache.asMap().put()`，但 `containsKey()` 和遍历 `entrySet()`除外。

需要提到的一点是，缓存框架 Caffeine 使用 Java 8 对 Guava 进行了重写，包括驱逐策略、过期策略和并发机制，使得缓存性能得到了显著提升，并且使用上可以兼容 Guava 的 API。 

```java
LoadingCache<String, String> cache = CaffeinatedGuava.build(
		Caffeine.newBuilder().maximumSize(MAX ENTRIES),
		new CacheLoader<String, String>() { //Guava’s CacheLoader
			@Override
			public String load(String key) throws Exception {
				return "";
			}
		});
```